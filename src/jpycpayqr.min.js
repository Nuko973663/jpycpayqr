const txt_version="2021.08.17.0";var default_dest_addr="0xafd382aCC893127D6fbb197b87453070Fc14D43d";const jpyc_contract_addr="0x6ae7dfc73e0dde2aa99ac063dcf7e8a63265108c",api_key="9FBQX79Z98UWDDQDH9QH6A6A1VFXU8VF9U",polygon_chain_id="137",polygon_chain_name="Polygon (MATIC)",list=["1","2","3","4","5","6","7","8","9","0"],debug_block=0,check_interval=1e3,total_check_count=180;var last_block=0,timer_id=0,counter=0;$(()=>{let id_pref="#btn-";list.forEach(e=>{$("#btn-"+e).on("click",()=>{$("#amount").val($("#amount").val()+e)})}),$("#btn-dot").on("click",()=>{-1==$("#amount").val().indexOf(".")&&$("#amount").val($("#amount").val()+".")}),$("#btn-clear").on("click",()=>{$("#amount").val("")}),$("#btn-generate").on("click",()=>{$("#amount").val.length>0&&($("#qrcontainer").css("display",""),makeCode(),move_to_link($("#qrcontainer")))}),$("#config").on("click",()=>{let dest=window.prompt("Input Destination Addr","");null!=dest&&(set_dest_addr(dest),get_dest_addr())}),$("#openMetamask").on("click",()=>{window.location.href="https://metamask.app.link/dapp/nuko973663.github.io/jpycpayqr/"}),$("#version").text(txt_version);var qrcode=new QRCode(document.getElementById("qrcode"),{width:300,height:300});const makeCode=()=>{let amount=$("#amount").val(),dest_addr=get_dest_addr(),code="ethereum:pay-"+jpyc_contract_addr+"@137/transfer?address="+dest_addr+"&uint256="+amount+"e18";qrcode.makeCode(code),$("#qrAmount").text(amount),$("#destAddress").text(dest_addr),$("#chainName").text("137 : Polygon (MATIC)"),getLastBlock(),counter=0,timer_id=setInterval(()=>{getNewTransactions(last_block),(counter+=1)>180&&clearInterval(timer_id)},1e3),$(".toast").toast()},getLastBlock=()=>{const url="https://api.polygonscan.com/api?module=proxy&action=eth_blockNumber&apikey="+api_key;fetch(url).then(response=>response.json()).then((function(json){let str;str=json.result,last_block=parseInt(Number(str),10)-0}))},getNewTransactions=startBlock=>{let dest_addr;const url="https://api.polygonscan.com/api?module=account&action=tokentx&address="+get_dest_addr()+"&startblock="+startBlock+"&sort=asc&apikey="+api_key;fetch(url).then(response=>response.json()).then((function(json){"1"==json.status&&(arr=json.result,arr.forEach(elm=>{let amount=$("#amount").val();if(elm.contractAddress==jpyc_contract_addr&&parseInt(elm.value)==parseInt(1e18*amount)){console.log(elm);let date=new Date(parseInt(elm.timeStamp));date.setHours(date.getHours()+4);let time=date.getHours()+":"+date.getMinutes()+":"+date.getSeconds();elm.time=time,elm.amount=amount,$("#toastContainer").prepend(build_toast(toast_text,elm)),$(".toast").toast("show")}let blockNum=parseInt(elm.blockNumber);blockNum>last_block&&(last_block=blockNum+1)}))}))},get_dest_addr=()=>{let dest_addr=localStorage.getItem("dest_addr");return null===dest_addr&&(dest_addr=default_dest_addr),$("#dest").text(dest_addr),dest_addr},set_dest_addr=addr=>{localStorage.setItem("dest_addr",addr)},move_to_link=link=>{var position=link.offset().top;$("body,html").animate({scrollTop:position},400,"swing")},build_toast=(txt,js)=>{for(let key in js)txt=txt.replaceAll("#"+key+"#",js[key]);return txt};window.addEventListener("load",async()=>{let accounts=[];if(window.ethereum){window.web3=new Web3(ethereum);try{await ethereum.enable(),accounts=await web3.eth.getAccounts()}catch(error){$("#askMetamask").modal("show")}}else if(window.web3)try{window.web3=new Web3(web3.currentProvider),accounts=await web3.eth.getAccounts()}catch(error){$("#askMetamask").modal("show")}else $("#askMetamask").modal("show");accounts.length>0?set_dest_addr(accounts[0]):$("#askMetamask").modal("show"),get_dest_addr()})});var toast_text='<div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-autohide="false">\n  <div class="toast-header">\n    <svg class="bd-placeholder-img rounded mr-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice" focusable="false" role="img" ><rect fill="#007aff" width="100%" height="100%"/></svg>\n    <strong class="mr-auto">#amount# #tokenSymbol#</strong>\n    <small class="text-muted">#time#</small>\n    <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">\n      <span aria-hidden="true">&times;</span>\n    </button>\n  </div>\n  <div class="toast-body">\n    <p>from: #from#<p>\n    <p><small><a href="https://polygonscan.com/tx/#hash#" target="_blank">tx: #hash#</a></small></p>\n  </div>\n</div>';